<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Conference (WebRTC)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .video-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        .video-box {
            flex: 1;
            min-width: 300px;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        .video-box video {
            width: 100%;
            height: auto;
            display: block;
        }
        .video-label {
            position: absolute;
            bottom: 10px;
            left: 10px;
            color: white;
            background: rgba(0,0,0,0.5);
            padding: 5px 10px;
            border-radius: 4px;
        }
        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        button {
            padding: 10px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #45a049;
        }
        button.danger {
            background: #f44336;
        }
        button.danger:hover {
            background: #d32f2f;
        }
        button.secondary {
            background: #2196F3;
        }
        button.secondary:hover {
            background: #0b7dda;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        #localVideo {
            width: 200px;
            height: 150px;
            background: #000;
            border-radius: 8px;
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
        }
        #waitingMessage {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 20px 0;
        }
        .participants {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Video Conference (WebRTC)</h1>
        
        <div class="form-group">
            <label for="username">Your Name</label>
            <input type="text" id="username" placeholder="Enter your name">
        </div>
        
        <div class="form-group">
            <label for="roomName">Room Name</label>
            <input type="text" id="roomName" placeholder="Enter room name">
        </div>
        
        <div class="controls">
            <button id="joinBtn">Join Room</button>
            <button id="leaveBtn" class="danger" disabled>Leave Room</button>
            <button id="toggleVideoBtn" class="secondary" disabled>Toggle Video</button>
            <button id="toggleAudioBtn" class="secondary" disabled>Toggle Audio</button>
        </div>
        
        <div id="conferenceArea" style="display: none;">
            <div class="video-container" id="remoteVideosContainer">
                <!-- Remote videos will be added here dynamically -->
            </div>
            
            <div id="waitingMessage">
                <p>Waiting for other participants to join...</p>
            </div>
            
            <div class="participants">
                <h3>Participants:</h3>
                <ul id="participantsList"></ul>
            </div>
        </div>
        
        <video id="localVideo" autoplay muted></video>
    </div>

    <!-- Подключаем PeerJS библиотеку -->
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    
    <script>
        // Global variables
        let localStream = null;
        let currentRoom = null;
        let currentUser = null;
        let isVideoEnabled = true;
        let isAudioEnabled = true;
        let videoTrack = null;
        let audioTrack = null;
        let peer = null;
        let peerId = null;
        let connections = {};
        
        // DOM elements
        const joinBtn = document.getElementById('joinBtn');
        const leaveBtn = document.getElementById('leaveBtn');
        const toggleVideoBtn = document.getElementById('toggleVideoBtn');
        const toggleAudioBtn = document.getElementById('toggleAudioBtn');
        const usernameInput = document.getElementById('username');
        const roomNameInput = document.getElementById('roomName');
        const localVideo = document.getElementById('localVideo');
        const remoteVideosContainer = document.getElementById('remoteVideosContainer');
        const waitingMessage = document.getElementById('waitingMessage');
        const participantsList = document.getElementById('participantsList');
        const conferenceArea = document.getElementById('conferenceArea');
        
        // Join room
        joinBtn.addEventListener('click', async () => {
            const username = usernameInput.value.trim();
            const roomName = roomNameInput.value.trim();
            
            if (!username || !roomName) {
                alert('Please enter your name and room name');
                return;
            }
            
            currentUser = username;
            currentRoom = roomName;
            
            try {
                // Get user media
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        frameRate: { ideal: 15, max: 20 }
                    },
                    audio: {
                        sampleRate: 16000,
                        channelCount: 1,
                        echoCancellation: true,
                        noiseSuppression: true
                    }
                });
                
                // Display local video
                localVideo.srcObject = localStream;
                videoTrack = localStream.getVideoTracks()[0];
                audioTrack = localStream.getAudioTracks()[0];
                
                // Initialize PeerJS
                await initializePeerJS(username);
                
                // Update UI
                joinBtn.disabled = true;
                leaveBtn.disabled = false;
                toggleVideoBtn.disabled = false;
                toggleAudioBtn.disabled = false;
                usernameInput.disabled = true;
                roomNameInput.disabled = true;
                conferenceArea.style.display = 'block';
                
                // Get list of other participants and connect to them
                await connectToOtherParticipants();
                
            } catch (error) {
                console.error('Error joining room:', error);
                alert('Error joining room: ' + error.message);
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                    localStream = null;
                }
                if (peer) {
                    peer.destroy();
                    peer = null;
                }
            }
        });
        
        // Initialize PeerJS connection
        async function initializePeerJS(username) {
            return new Promise((resolve, reject) => {
                // Get a PeerJS ID from our server
                fetch('/api/get_peer_id', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ user_id: username })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Create PeerJS instance
                        peer = new Peer(data.peer_id);
                        
                        peer.on('open', (id) => {
                            console.log('PeerJS connected with ID:', id);
                            peerId = id;
                            resolve();
                        });
                        
                        peer.on('error', (err) => {
                            console.error('PeerJS error:', err);
                            reject(err);
                        });
                        
                        // Handle incoming connections
                        peer.on('connection', (conn) => {
                            console.log('Incoming connection from:', conn.peer);
                            
                            conn.on('open', () => {
                                console.log('Connection established with:', conn.peer);
                                connections[conn.peer] = conn;
                                updateParticipantsList();
                            });
                            
                            conn.on('close', () => {
                                console.log('Connection closed with:', conn.peer);
                                removeParticipant(conn.peer);
                                delete connections[conn.peer];
                                updateParticipantsList();
                            });
                        });
                        
                        // Handle incoming calls
                        peer.on('call', (call) => {
                            console.log('Incoming call from:', call.peer);
                            
                            // Answer the call with our local stream
                            call.answer(localStream);
                            
                            // Handle the stream from the caller
                            call.on('stream', (remoteStream) => {
                                addRemoteVideo(call.peer, remoteStream);
                            });
                            
                            call.on('close', () => {
                                console.log('Call ended with:', call.peer);
                                removeRemoteVideo(call.peer);
                            });
                        });
                        
                    } else {
                        reject(new Error(data.error || 'Failed to get PeerJS ID'));
                    }
                })
                .catch(reject);
            });
        }
        
        // Connect to other participants in the room
        async function connectToOtherParticipants() {
            try {
                const response = await fetch('/api/get_peer_ids', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        room_name: currentRoom,
                        current_user: currentUser
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Connect to each peer and initiate call
                    for (const [user, peerId] of Object.entries(data.peers)) {
                        // Create data connection
                        const conn = peer.connect(peerId);
                        
                        conn.on('open', () => {
                            console.log('Connected to peer:', peerId);
                            connections[peerId] = conn;
                            updateParticipantsList();
                            
                            // Initiate call after connection is established
                            const call = peer.call(peerId, localStream);
                            
                            call.on('stream', (remoteStream) => {
                                addRemoteVideo(peerId, remoteStream);
                            });
                            
                            call.on('close', () => {
                                console.log('Call ended with:', peerId);
                                removeRemoteVideo(peerId);
                            });
                        });
                        
                        conn.on('close', () => {
                            console.log('Connection closed with:', peerId);
                            removeParticipant(peerId);
                            delete connections[peerId];
                            updateParticipantsList();
                        });
                    }
                    
                    if (Object.keys(data.peers).length === 0) {
                        waitingMessage.style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('Error connecting to other participants:', error);
            }
        }
        
        // Add remote video element
        function addRemoteVideo(peerId, stream) {
            // Check if video already exists
            if (document.getElementById(`remoteVideo-${peerId}`)) return;
            
            waitingMessage.style.display = 'none';
            
            const videoBox = document.createElement('div');
            videoBox.className = 'video-box';
            videoBox.id = `videoBox-${peerId}`;
            
            const video = document.createElement('video');
            video.id = `remoteVideo-${peerId}`;
            video.autoplay = true;
            video.playsInline = true;
            video.srcObject = stream;
            
            const label = document.createElement('div');
            label.className = 'video-label';
            label.id = `remoteVideoLabel-${peerId}`;
            label.textContent = getUsernameFromPeerId(peerId) || peerId;
            
            videoBox.appendChild(video);
            videoBox.appendChild(label);
            remoteVideosContainer.appendChild(videoBox);
        }
        
        // Remove remote video element
        function removeRemoteVideo(peerId) {
            const videoBox = document.getElementById(`videoBox-${peerId}`);
            if (videoBox) {
                videoBox.remove();
            }
            
            // Show waiting message if no more participants
            if (remoteVideosContainer.children.length === 0) {
                waitingMessage.style.display = 'block';
            }
        }
        
        // Get username from peerId (simplified)
        function getUsernameFromPeerId(peerId) {
            // In a real app, you would map peerIds to usernames
            // For simplicity, we'll just return the peerId
            return peerId;
        }
        
        // Update participants list
        function updateParticipantsList() {
            participantsList.innerHTML = '';
            
            // Add current user
            const currentUserLi = document.createElement('li');
            currentUserLi.textContent = `${currentUser} (You)`;
            participantsList.appendChild(currentUserLi);
            
            // Add other participants
            for (const peerId of Object.keys(connections)) {
                const li = document.createElement('li');
                li.textContent = getUsernameFromPeerId(peerId) || peerId;
                participantsList.appendChild(li);
            }
        }
        
        // Remove participant from UI
        function removeParticipant(peerId) {
            const participantItems = participantsList.getElementsByTagName('li');
            for (let i = 0; i < participantItems.length; i++) {
                if (participantItems[i].textContent === (getUsernameFromPeerId(peerId) || peerId)) {
                    participantItems[i].remove();
                    break;
                }
            }
        }
        
        // Leave room
        leaveBtn.addEventListener('click', async () => {
            if (confirm('Are you sure you want to leave the room?')) {
                await leaveRoom();
            }
        });
        
        // Toggle video
        toggleVideoBtn.addEventListener('click', () => {
            isVideoEnabled = !isVideoEnabled;
            if (videoTrack) {
                videoTrack.enabled = isVideoEnabled;
            }
            toggleVideoBtn.textContent = isVideoEnabled ? 'Toggle Video' : 'Enable Video';
            
            // Notify other participants about the change
            for (const conn of Object.values(connections)) {
                conn.send({
                    type: 'video_toggle',
                    enabled: isVideoEnabled
                });
            }
        });
        
        // Toggle audio
        toggleAudioBtn.addEventListener('click', () => {
            isAudioEnabled = !isAudioEnabled;
            if (audioTrack) {
                audioTrack.enabled = isAudioEnabled;
            }
            toggleAudioBtn.textContent = isAudioEnabled ? 'Toggle Audio' : 'Enable Audio';
            
            // Notify other participants about the change
            for (const conn of Object.values(connections)) {
                conn.send({
                    type: 'audio_toggle',
                    enabled: isAudioEnabled
                });
            }
        });
        
        // Leave the room
        async function leaveRoom() {
            // Close all connections
            for (const conn of Object.values(connections)) {
                conn.close();
            }
            connections = {};
            
            // Stop local stream
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            // Destroy PeerJS instance
            if (peer) {
                peer.destroy();
                peer = null;
            }
            
            // Notify server we're leaving
            try {
                await fetch('/api/get_peer_ids', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        room_name: currentRoom,
                        current_user: currentUser,
                        action: 'leave'
                    })
                });
            } catch (error) {
                console.error('Error notifying server about leaving:', error);
            }
            
            // Reset UI
            joinBtn.disabled = false;
            leaveBtn.disabled = true;
            toggleVideoBtn.disabled = true;
            toggleAudioBtn.disabled = true;
            usernameInput.disabled = false;
            roomNameInput.disabled = false;
            conferenceArea.style.display = 'none';
            localVideo.srcObject = null;
            remoteVideosContainer.innerHTML = '';
            participantsList.innerHTML = '';
            waitingMessage.style.display = 'block';
            
            currentRoom = null;
            currentUser = null;
            peerId = null;
        }
        
        // Handle page unload
        window.addEventListener('beforeunload', async () => {
            if (currentRoom) {
                await leaveRoom();
            }
        });
    </script>
</body>
</html>