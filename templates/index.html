<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Conference</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .video-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        .video-box {
            flex: 1;
            min-width: 300px;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        .video-box video, .video-box img {
            width: 100%;
            height: auto;
            display: block;
        }
        .video-label {
            position: absolute;
            bottom: 10px;
            left: 10px;
            color: white;
            background: rgba(0,0,0,0.5);
            padding: 5px 10px;
            border-radius: 4px;
        }
        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        button {
            padding: 10px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #45a049;
        }
        button.danger {
            background: #f44336;
        }
        button.danger:hover {
            background: #d32f2f;
        }
        button.secondary {
            background: #2196F3;
        }
        button.secondary:hover {
            background: #0b7dda;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        #localVideo {
            width: 200px;
            height: 150px;
            background: #000;
            border-radius: 8px;
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
        }
        #waitingMessage {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 20px 0;
        }
        .participants {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Video Conference</h1>
        
        <div class="form-group">
            <label for="username">Your Name</label>
            <input type="text" id="username" placeholder="Enter your name">
        </div>
        
        <div class="form-group">
            <label for="roomName">Room Name</label>
            <input type="text" id="roomName" placeholder="Enter room name">
        </div>
        
        <div class="controls">
            <button id="joinBtn">Join Room</button>
            <button id="leaveBtn" class="danger" disabled>Leave Room</button>
            <button id="toggleVideoBtn" class="secondary" disabled>Toggle Video</button>
            <button id="toggleAudioBtn" class="secondary" disabled>Toggle Audio</button>
        </div>
        
        <div id="conferenceArea" style="display: none;">
            <div class="video-container">
                <div class="video-box" id="remoteVideoContainer">
                    <img id="remoteVideo" alt="Remote video">
                    <div class="video-label" id="remoteVideoLabel"></div>
                </div>
            </div>
            
            <div id="waitingMessage">
                <p>Waiting for other participants to join...</p>
            </div>
            
            <div class="participants">
                <h3>Participants:</h3>
                <ul id="participantsList"></ul>
            </div>
        </div>
        
        <video id="localVideo" autoplay muted></video>
    </div>

    <script>
        // Global variables
        let localStream = null;
        let currentRoom = null;
        let currentUser = null;
        let isVideoEnabled = true;
        let isAudioEnabled = true;
        let videoInterval = null;
        let audioInterval = null;
        let videoTrack = null;
        let audioTrack = null;
        
        // DOM elements
        const joinBtn = document.getElementById('joinBtn');
        const leaveBtn = document.getElementById('leaveBtn');
        const toggleVideoBtn = document.getElementById('toggleVideoBtn');
        const toggleAudioBtn = document.getElementById('toggleAudioBtn');
        const usernameInput = document.getElementById('username');
        const roomNameInput = document.getElementById('roomName');
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const remoteVideoLabel = document.getElementById('remoteVideoLabel');
        const remoteVideoContainer = document.getElementById('remoteVideoContainer');
        const waitingMessage = document.getElementById('waitingMessage');
        const participantsList = document.getElementById('participantsList');
        const conferenceArea = document.getElementById('conferenceArea');
        
        // Join room
        joinBtn.addEventListener('click', async () => {
            const username = usernameInput.value.trim();
            const roomName = roomNameInput.value.trim();
            
            if (!username || !roomName) {
                alert('Please enter your name and room name');
                return;
            }
            
            currentUser = username;
            currentRoom = roomName;
            
            try {
                // Get user media
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        frameRate: { ideal: 15, max: 20 }
                    },
                    audio: {
                        sampleRate: 16000,
                        channelCount: 1,
                        echoCancellation: true,
                        noiseSuppression: true
                    }
                });
                
                // Display local video
                localVideo.srcObject = localStream;
                videoTrack = localStream.getVideoTracks()[0];
                audioTrack = localStream.getAudioTracks()[0];
                
                // Join the room
                const response = await fetch(`/api/conference/${roomName}/join`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ user_id: username })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Start sending video
                    startSendingVideo(roomName, username);
                    // Start sending audio
                    startSendingAudio(roomName, username);
                    // Start receiving video
                    startReceivingVideo(roomName, username);
                    // Start receiving audio
                    startReceivingAudio(roomName, username);
                    
                    // Update UI
                    joinBtn.disabled = true;
                    leaveBtn.disabled = false;
                    toggleVideoBtn.disabled = false;
                    toggleAudioBtn.disabled = false;
                    usernameInput.disabled = true;
                    roomNameInput.disabled = true;
                    conferenceArea.style.display = 'block';
                    
                    // Update participants list
                    updateParticipantsList(roomName);
                } else {
                    alert('Failed to join room: ' + (data.error || 'Unknown error'));
                    localStream.getTracks().forEach(track => track.stop());
                    localStream = null;
                }
            } catch (error) {
                console.error('Error joining room:', error);
                alert('Error joining room: ' + error.message);
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                    localStream = null;
                }
            }
        });
        
        // Leave room
        leaveBtn.addEventListener('click', async () => {
            if (confirm('Are you sure you want to leave the room?')) {
                await leaveRoom();
            }
        });
        
        // Toggle video
        toggleVideoBtn.addEventListener('click', () => {
            isVideoEnabled = !isVideoEnabled;
            if (videoTrack) {
                videoTrack.enabled = isVideoEnabled;
            }
            toggleVideoBtn.textContent = isVideoEnabled ? 'Toggle Video' : 'Enable Video';
        });
        
        // Toggle audio
        toggleAudioBtn.addEventListener('click', () => {
            isAudioEnabled = !isAudioEnabled;
            if (audioTrack) {
                audioTrack.enabled = isAudioEnabled;
            }
            toggleAudioBtn.textContent = isAudioEnabled ? 'Toggle Audio' : 'Enable Audio';
        });
        
        // Start sending video frames
        function startSendingVideo(roomName, userId) {
            const video = document.getElementById('localVideo');
            const canvas = document.createElement('canvas');
            canvas.width = 640;
            canvas.height = 480;
            const ctx = canvas.getContext('2d');
            
            videoInterval = setInterval(async () => {
                if (!isVideoEnabled) return;
                
                try {
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const frame = canvas.toDataURL('image/jpeg', 0.7);
                    
                    await fetch(`/api/conference/${roomName}/video`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            user_id: userId,
                            frame: frame,
                            timestamp: Date.now()
                        })
                    });
                } catch (error) {
                    console.error('Error sending video frame:', error);
                }
            }, 1000 / 15); // 15 FPS
        }
        
        // Start sending audio data
        function startSendingAudio(roomName, userId) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const source = audioContext.createMediaStreamSource(localStream);
            const processor = audioContext.createScriptProcessor(4096, 1, 1);
            
            source.connect(processor);
            processor.connect(audioContext.destination);
            
            processor.onaudioprocess = async (e) => {
                if (!isAudioEnabled) return;
                
                try {
                    const audioData = e.inputBuffer.getChannelData(0);
                    const audioArray = Array.from(audioData);
                    
                    await fetch(`/api/conference/${roomName}/audio`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            user_id: userId,
                            audio: audioArray,
                            timestamp: Date.now()
                        })
                    });
                } catch (error) {
                    console.error('Error sending audio:', error);
                }
            };
            
            audioInterval = processor;
        }
        
        // Start receiving video
        function startReceivingVideo(roomName, userId) {
            async function updateRemoteVideo() {
                try {
                    // Get participants
                    const response = await fetch(`/api/conference/${roomName}/join`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ user_id: userId })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        // For each participant (except self), get video
                        for (const participant of data.participants) {
                            if (participant === userId) continue;
                            
                            remoteVideo.src = `/video_feed/${roomName}/${participant}?t=${Date.now()}`;
                            remoteVideoLabel.textContent = participant;
                            waitingMessage.style.display = 'none';
                            remoteVideoContainer.style.display = 'block';
                            break; // Show only one participant for simplicity
                        }
                        
                        if (data.participants.length <= 1) {
                            waitingMessage.style.display = 'block';
                            remoteVideoContainer.style.display = 'none';
                        }
                    }
                    
                    // Update participants list
                    updateParticipantsList(roomName);
                    
                    // Repeat
                    setTimeout(updateRemoteVideo, 1000);
                } catch (error) {
                    console.error('Error updating remote video:', error);
                    setTimeout(updateRemoteVideo, 1000);
                }
            }
            
            updateRemoteVideo();
        }
        
        // Start receiving audio
        function startReceivingAudio(roomName, userId) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            async function updateRemoteAudio() {
                try {
                    // Get participants
                    const response = await fetch(`/api/conference/${roomName}/join`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ user_id: userId })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        // For each participant (except self), get audio
                        for (const participant of data.participants) {
                            if (participant === userId) continue;
                            
                            const audioResponse = await fetch(`/api/conference/${roomName}/audio/${participant}`);
                            const audioData = await audioResponse.json();
                            
                            if (audioData.success && audioData.audio) {
                                playAudio(audioContext, audioData.audio);
                            }
                        }
                    }
                    
                    // Repeat
                    setTimeout(updateRemoteAudio, 100);
                } catch (error) {
                    console.error('Error updating remote audio:', error);
                    setTimeout(updateRemoteAudio, 100);
                }
            }
            
            updateRemoteAudio();
        }
        
        // Play received audio
        function playAudio(audioContext, audioArray) {
            try {
                const audioBuffer = audioContext.createBuffer(1, audioArray.length, audioContext.sampleRate);
                const channelData = audioBuffer.getChannelData(0);
                
                for (let i = 0; i < audioArray.length; i++) {
                    channelData[i] = audioArray[i];
                }
                
                const source = audioContext.createBufferSource();
                source.buffer = audioBuffer;
                source.connect(audioContext.destination);
                source.start();
            } catch (error) {
                console.error('Error playing audio:', error);
            }
        }
        
        // Update participants list
        async function updateParticipantsList(roomName) {
            try {
                const response = await fetch(`/api/conference/${roomName}/join`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ user_id: currentUser })
                });
                
                const data = await response.json();
                if (data.success) {
                    participantsList.innerHTML = '';
                    data.participants.forEach(participant => {
                        const li = document.createElement('li');
                        li.textContent = participant;
                        participantsList.appendChild(li);
                    });
                }
            } catch (error) {
                console.error('Error updating participants list:', error);
            }
        }
        
        // Leave the room
        async function leaveRoom() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            if (videoInterval) clearInterval(videoInterval);
            if (audioInterval) {
                audioInterval.disconnect();
                audioInterval = null;
            }
            
            if (currentRoom && currentUser) {
                await fetch(`/api/conference/${currentRoom}/leave`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ user_id: currentUser })
                });
            }
            
            // Reset UI
            joinBtn.disabled = false;
            leaveBtn.disabled = true;
            toggleVideoBtn.disabled = true;
            toggleAudioBtn.disabled = true;
            usernameInput.disabled = false;
            roomNameInput.disabled = false;
            conferenceArea.style.display = 'none';
            localVideo.srcObject = null;
            remoteVideo.src = '';
            participantsList.innerHTML = '';
            
            currentRoom = null;
            currentUser = null;
        }
        
        // Handle page unload
        window.addEventListener('beforeunload', async () => {
            if (currentRoom) {
                await leaveRoom();
            }
        });
    </script>
</body>
</html>
